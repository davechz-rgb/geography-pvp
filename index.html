<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Geography Trainer ‚Äî PvP MVP</title>
  <style>
    :root{
      --bg0:#070b12; --bg1:#0b1221; --card:rgba(255,255,255,.06);
      --line:rgba(255,255,255,.10); --text:#eef4ff; --muted:rgba(238,244,255,.70);
      --good:#3be38d; --bad:#ff5a7a; --accent:#7aa7ff; --accent2:#6ef3ff;
      --shadow: 0 16px 40px rgba(0,0,0,.40);
      --r:18px;
      --btn: rgba(255,255,255,.08);
      --btn2: rgba(255,255,255,.12);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background: radial-gradient(1200px 800px at 20% -10%, rgba(110,243,255,.15), transparent 55%),
                  radial-gradient(1100px 700px at 90% 0%, rgba(122,167,255,.18), transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px 16px 36px}
    .topbar{
      position:sticky; top:0; z-index:10;
      padding:12px 0 10px;
      backdrop-filter: blur(14px);
      background: linear-gradient(180deg, rgba(7,11,18,.82), rgba(7,11,18,.35));
    }
    .hud{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
    }
    .brand{
      display:flex; align-items:center; gap:10px; font-weight:800;
      letter-spacing:.2px;
    }
    .pillrow{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      background: var(--card);
      border:1px solid var(--line);
      box-shadow: 0 8px 24px rgba(0,0,0,.25);
      font-size:13px; color:var(--muted);
      user-select:none;
    }
    .pill strong{color:var(--text); font-weight:800}
    .pill.click{cursor:pointer; pointer-events:auto}
    .pill.click:hover{background:rgba(255,255,255,.10)}
    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
    }
    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:16px; margin-top:14px}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }
    .panel{padding:16px}
    h1{margin:0 0 4px 0; font-size:18px}
    .sub{color:var(--muted); font-size:13px; margin-bottom:12px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    input{
      background:rgba(0,0,0,.25); border:1px solid var(--line); color:var(--text);
      border-radius:12px; padding:10px 12px; font-size:14px; outline:none; min-width:220px;
    }
    input:focus{border-color:rgba(122,167,255,.55); box-shadow:0 0 0 3px rgba(122,167,255,.15)}
    button{
      border:1px solid var(--line);
      background: var(--btn);
      color:var(--text);
      border-radius: 12px;
      padding:10px 12px;
      font-weight:800;
      cursor:pointer;
      transition: transform .06s ease, background .15s ease;
    }
    button:hover{background: var(--btn2)}
    button:active{transform: translateY(1px)}
    .primary{
      border:none;
      background: linear-gradient(90deg, rgba(110,243,255,.95), rgba(122,167,255,.95));
      color:#08101f;
    }
    .primary:hover{filter:brightness(1.02)}
    .danger{background: rgba(255,90,122,.15); border-color: rgba(255,90,122,.35)}
    .muted{color:var(--muted)}
    .roomcode{
      font-size:28px; letter-spacing:4px; font-weight:900; margin:8px 0 0;
    }
    .status{
      margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;
    }
    .badge{
      padding:8px 10px; border-radius:999px; border:1px solid var(--line); background:rgba(0,0,0,.2);
      font-size:13px; color:var(--muted);
    }
    .badge strong{color:var(--text)}
    .game{
      padding:16px;
      margin-top:16px;
    }
    .qtitle{display:flex; align-items:center; justify-content:space-between; gap:12px}
    .qtitle h2{margin:0; font-size:18px}
    .qmeta{color:var(--muted); font-size:13px}
    .flag{
      font-size:44px; line-height:1; margin:10px 0 2px;
      filter: drop-shadow(0 10px 14px rgba(0,0,0,.35));
    }
    .prompt{font-size:16px; font-weight:800; margin:10px 0 10px}
    .answers{display:grid; gap:10px; grid-template-columns: 1fr 1fr}
    @media (max-width:650px){ .answers{grid-template-columns:1fr} }
    .ans{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      text-align:left;
      font-weight:800;
    }
    .ans small{display:block; font-weight:700; color:var(--muted); margin-top:3px}
    .ans.correct{border-color: rgba(59,227,141,.55); background: rgba(59,227,141,.12)}
    .ans.wrong{border-color: rgba(255,90,122,.55); background: rgba(255,90,122,.12)}
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background: rgba(0,0,0,.55); border:1px solid var(--line);
      padding:10px 12px; border-radius:999px; color:var(--text);
      opacity:0; pointer-events:none; transition: opacity .15s ease, transform .15s ease;
      backdrop-filter: blur(10px);
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-6px)}
    .results h3{margin:0 0 10px 0}
    .list{display:grid; gap:10px}
    .item{
      padding:12px; border-radius:14px; border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      display:flex; justify-content:space-between; align-items:center; gap:12px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="hud">
        <div class="brand">
          üåç <span>Geography PvP</span>
        </div>
        <div class="pillrow">
          <div class="pill">Room: <strong id="hudRoom">‚Äî</strong></div>
          <div class="pill">You: <strong id="hudYou">‚Äî</strong></div>
          <div class="pill">Opponent: <strong id="hudOpp">‚Äî</strong></div>
          <div class="pill click" id="musicChip" title="Toggle music">üéµ <strong id="hudMusic">ON</strong></div>
          <div class="pill click" id="hapticsChip" title="Toggle haptics">üì≥ <strong id="hudHaptics">ON</strong></div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card panel">
        <h1>Play online (Pregunta2-style)</h1>
        <div class="sub">Create a room, share the code, then start. Both players receive the same questions and options.</div>

        <div class="row" style="align-items:center">
          <input id="name" placeholder="Your name (e.g., Mateo)" maxlength="18"/>
          <button class="primary" id="createBtn">Create room</button>
        </div>

        <div style="height:10px"></div>

        <div class="row" style="align-items:center">
          <input id="roomInput" placeholder="Enter room code (e.g., K7M3PZ)" maxlength="6"/>
          <button id="joinBtn">Join room</button>
        </div>

        <div class="status">
          <div class="badge">Questions: <strong id="cfgN">20</strong></div>
          <div class="badge">Include flags: <strong id="cfgF">YES</strong></div>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="qMinus">‚àí</button>
          <button id="qPlus">+</button>
          <button id="toggleFlags">Toggle flags</button>
        </div>

        <div style="margin-top:12px" class="muted">
          Tip: on Render free tier the first match may take a few seconds to wake up.
        </div>
      </div>

      <div class="card panel">
        <h1>Room</h1>
        <div class="sub">Share this code with your friend.</div>
        <div class="roomcode" id="roomCode">‚Äî</div>
        <div class="status" id="roomStatus"></div>
        <div style="height:10px"></div>
        <div class="row">
          <button class="primary" id="startBtn" disabled>Start game</button>
          <button class="danger" id="leaveBtn" disabled>Leave</button>
        </div>
      </div>
    </div>

    <div class="card game" id="gameCard" style="display:none">
      <div class="qtitle">
        <h2 id="qHeader">Question</h2>
        <div class="qmeta"><span id="qIndex">0</span>/<span id="qTotal">0</span></div>
      </div>
      <div id="flagBox" class="flag" style="display:none">üè≥Ô∏è</div>
      <div class="prompt" id="prompt">‚Äî</div>
      <div class="answers" id="answers"></div>
      <div class="sub" id="feedback" style="margin-top:10px"></div>
    </div>

    <div class="card panel results" id="resultsCard" style="display:none; margin-top:16px">
      <h1>Results</h1>
      <div class="sub" id="winnerLine">‚Äî</div>
      <div class="list" id="resultsList"></div>
      <div style="height:10px"></div>
      <button class="primary" id="playAgainBtn">Play again</button>
    </div>

  </div>

  <div class="toast" id="toast">‚Äî</div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const $ = (id)=>document.getElementById(id);

    /* ---------- haptics ---------- */
    let settings = { music:true, haptics:true };
    function vibrate(ms=18){
      if(!settings.haptics) return;
      if("vibrate" in navigator) navigator.vibrate(ms);
    }
    function syncHapticsUI(){
      $('hudHaptics').textContent = settings.haptics ? 'ON' : 'OFF';
      $('hapticsChip').textContent = settings.haptics ? 'üì≥ ON' : 'üì¥ OFF';
    }

    /* ---------- music (soft loop) ---------- */
    let audioCtx = null;
    let music = { running:false, gain:null, osc:null, timer:null, step:0 };
    const NOTES = [220, 246.94, 196, 174.61, 220, 261.63, 246.94, 196];
    function ensureAudio(){
      audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
      return audioCtx;
    }
    function startMusic(){
      if(music.running) return;
      try{
        const ctx = ensureAudio();
        const g = ctx.createGain(); g.gain.value = 0.03;
        const o = ctx.createOscillator(); o.type = 'sine'; o.frequency.value = NOTES[0];
        o.connect(g); g.connect(ctx.destination); o.start();
        music = { running:true, gain:g, osc:o, timer:null, step:0 };
        music.timer = setInterval(()=>{
          if(!music.running) return;
          music.step = (music.step + 1) % NOTES.length;
          const t = ctx.currentTime;
          o.frequency.setTargetAtTime(NOTES[music.step], t, 0.12);
        }, 650);
      }catch(e){}
    }
    function stopMusic(){
      if(!music.running) return;
      try{
        clearInterval(music.timer);
        const ctx = ensureAudio();
        const t = ctx.currentTime;
        music.gain && music.gain.gain.setTargetAtTime(0.0001, t, 0.06);
        setTimeout(()=>{
          try{ music.osc && music.osc.stop(); }catch(e){}
          try{ music.osc && music.osc.disconnect(); }catch(e){}
          try{ music.gain && music.gain.disconnect(); }catch(e){}
          music = { running:false, gain:null, osc:null, timer:null, step:0 };
        }, 220);
      }catch(e){ music.running=false; }
    }
    function syncMusicUI(){
      $('hudMusic').textContent = settings.music ? 'ON' : 'OFF';
      $('musicChip').textContent = settings.music ? 'üéµ ON' : 'üéµ OFF';
      if(settings.music) startMusic(); else stopMusic();
    }
    function unlockAudioOnce(){
      try{ const ctx = ensureAudio(); if(ctx.state === 'suspended') ctx.resume(); }catch(e){}
      syncMusicUI();
      document.removeEventListener('pointerdown', unlockAudioOnce, {capture:true});
      document.removeEventListener('keydown', unlockAudioOnce, {capture:true});
    }
    document.addEventListener('pointerdown', unlockAudioOnce, {capture:true, once:true});
    document.addEventListener('keydown', unlockAudioOnce, {capture:true, once:true});

    /* ---------- toast ---------- */
    let toastTimer=null;
    function toast(msg){
      const el=$('toast');
      el.textContent=msg;
      el.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer=setTimeout(()=>el.classList.remove('show'), 1400);
    }

    /* ---------- socket ---------- */
    const socket = io();

    let roomId = null;
    let youId = null;
    let pack = [];
    let qIndex = 0;
    let locked = false;
    let answerLog = new Map(); // qIndex -> {correctAnswer, myChoice}

    // config
    let cfg = { numQuestions: 20, allowFlags: true };
    function syncCfg(){
      $('cfgN').textContent = cfg.numQuestions;
      $('cfgF').textContent = cfg.allowFlags ? "YES" : "NO";
    }
    syncCfg();

    // UI handlers
    $('qMinus').onclick = ()=>{ cfg.numQuestions = Math.max(10, cfg.numQuestions-5); syncCfg(); vibrate(10); };
    $('qPlus').onclick = ()=>{ cfg.numQuestions = Math.min(50, cfg.numQuestions+5); syncCfg(); vibrate(10); };
    $('toggleFlags').onclick = ()=>{ cfg.allowFlags = !cfg.allowFlags; syncCfg(); toast("Include flags: " + (cfg.allowFlags?"YES":"NO")); vibrate(12); };

    $('musicChip').onclick = ()=>{ settings.music = !settings.music; syncMusicUI(); toast(settings.music?"Music ON":"Music OFF"); vibrate(12); };
    $('hapticsChip').onclick = ()=>{ settings.haptics = !settings.haptics; syncHapticsUI(); toast(settings.haptics?"Haptics ON":"Haptics OFF"); vibrate(12); };

    $('createBtn').onclick = ()=>{
      const name = ($('name').value || "Player 1").trim();
      socket.emit("create_room", { name, numQuestions: cfg.numQuestions, allowFlags: cfg.allowFlags });
      toast("Creating room...");
      vibrate(12);
    };
    $('joinBtn').onclick = ()=>{
      const name = ($('name').value || "Player 2").trim();
      const code = ($('roomInput').value || "").trim().toUpperCase();
      socket.emit("join_room", { roomId: code, name });
      toast("Joining...");
      vibrate(12);
    };
    $('startBtn').onclick = ()=>{
      if(!roomId) return;
      socket.emit("start_game", { roomId });
      vibrate(12);
    };
    $('leaveBtn').onclick = ()=>{
      if(!roomId) return;
      socket.emit("leave_room", { roomId });
      resetToLobby();
      toast("Left room");
      vibrate(12);
    };
    $('playAgainBtn').onclick = ()=>{
      resetToLobby();
      toast("Ready");
      vibrate(12);
    };

    function resetToLobby(){
      roomId=null;
      $('hudRoom').textContent="‚Äî";
      $('roomCode').textContent="‚Äî";
      $('roomStatus').innerHTML="";
      $('startBtn').disabled=true;
      $('leaveBtn').disabled=true;
      $('gameCard').style.display="none";
      $('resultsCard').style.display="none";
      pack=[]; qIndex=0; locked=false;
      answerLog.clear();
    }

    function renderRoomState(state){
      if(!state) return;
      roomId = state.roomId;
      $('hudRoom').textContent = roomId;
      $('roomCode').textContent = roomId;
      $('hudYou').textContent = "‚Äî";
      $('hudOpp').textContent = "‚Äî";
      const me = state.players.find(p=>p.id===socket.id);
      const opp = state.players.find(p=>p.id!==socket.id);
      $('hudYou').textContent = me ? me.name : "‚Äî";
      $('hudOpp').textContent = opp ? opp.name : "‚Äî";

      $('roomStatus').innerHTML = "";
      const s1 = document.createElement("div");
      s1.className = "badge";
      s1.innerHTML = `Status: <strong>${state.status.toUpperCase()}</strong>`;
      const s2 = document.createElement("div");
      s2.className = "badge";
      s2.innerHTML = `Players: <strong>${state.players.length}/2</strong>`;
      const s3 = document.createElement("div");
      s3.className = "badge";
      s3.innerHTML = `Questions: <strong>${state.total}</strong>`;
      $('roomStatus').appendChild(s1); $('roomStatus').appendChild(s2); $('roomStatus').appendChild(s3);

      $('leaveBtn').disabled = false;
      $('startBtn').disabled = !(state.status==="lobby" && state.players.length===2);
    }

    socket.on("room_created", ({roomId:rid})=>{
      $('roomInput').value = rid;
      toast("Room created");
      vibrate(18);
    });

    socket.on("room_state", (state)=>{
      renderRoomState(state);
    });

    socket.on("error_msg", ({message})=>{
      toast(message || "Error");
      vibrate(35);
    });

    socket.on("game_started", ({pack:serverPack})=>{
      pack = serverPack;
      qIndex = 0;
      locked = false;
      answerLog.clear();
      $('resultsCard').style.display="none";
      $('gameCard').style.display="block";
      renderQuestion();
      toast("Game started!");
      vibrate(20);
    });

    socket.on("answer_update", ({playerId, qIndex:qi, correct, correctAnswer})=>{
      // store correct answer for feedback
      const cur = answerLog.get(qi) || {};
      cur.correctAnswer = correctAnswer;
      answerLog.set(qi, cur);

      // if it's me, show feedback immediately (we also do local feedback)
      if(playerId === socket.id){
        // nothing extra
      }
    });

    socket.on("game_finished", ({results, winnerId})=>{
      $('gameCard').style.display="none";
      $('resultsCard').style.display="block";
      const winner = results.find(r=>r.id===winnerId);
      $('winnerLine').textContent = winner ? `${winner.name} wins!` : "Finished.";
      const list = $('resultsList');
      list.innerHTML = "";
      for(const r of results){
        const el = document.createElement("div");
        el.className = "item";
        const sec = (r.timeMs/1000).toFixed(2);
        el.innerHTML = `<div><strong>${r.name}</strong><div class="muted">${r.correct} correct</div></div><div><strong>${sec}s</strong></div>`;
        list.appendChild(el);
      }
      toast("Finished");
      vibrate(40);
    });

    function renderQuestion(){
      const q = pack[qIndex];
      $('qHeader').textContent = `Question`;
      $('qIndex').textContent = (qIndex+1);
      $('qTotal').textContent = pack.length;
      $('feedback').textContent = "";
      locked = false;

      if(q.topic === "flag"){
        $('flagBox').style.display = "block";
        $('flagBox').textContent = q.flag || "üè≥Ô∏è";
      }else{
        $('flagBox').style.display = "none";
      }

      $('prompt').textContent = q.prompt;

      const box = $('answers');
      box.innerHTML = "";

      q.options.forEach(opt=>{
        const b = document.createElement("button");
        b.className = "ans";
        b.textContent = opt;
        b.onclick = ()=> choose(opt, b);
        box.appendChild(b);
      });
    }

    function choose(choice, btn){
      if(locked) return;
      locked = true;
      const q = pack[qIndex];
      // send to server
      socket.emit("answer", { roomId, qIndex, choice });

      const correct = (choice === q.answer);
      // paint buttons
      const buttons = Array.from(document.querySelectorAll(".ans"));
      for(const b of buttons){
        if(b.textContent === q.answer) b.classList.add("correct");
        else if(b.textContent === choice) b.classList.add("wrong");
      }
      $('feedback').innerHTML = correct
        ? `<span style="color:var(--good);font-weight:900">‚úÖ Correct</span>`
        : `<span style="color:var(--bad);font-weight:900">‚ùå Wrong</span> <span class="muted">Correct answer: <strong>${q.answer}</strong></span>`;

      vibrate(correct ? 18 : 35);

      setTimeout(()=>{
        qIndex++;
        if(qIndex >= pack.length){
          $('feedback').textContent = "Waiting for opponent to finish‚Ä¶";
          return;
        }
        renderQuestion();
      }, 800);
    }

    // init toggles
    syncHapticsUI();
    syncMusicUI();
    resetToLobby();
  </script>
</body>
</html>
